@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import partials._
@import uk.gov.hmrc.selfservicetimetopay.models.SelectedPlanAmount
@import ssttpcalculator.model._
@import model._
@import helpers.forms.submit
@import uk.gov.hmrc.govukfrontend.views.Aliases.Radios
@import uk.gov.hmrc.govukfrontend.views.Aliases.RadioItem
@import uk.gov.hmrc.govukfrontend.views.Aliases.Text
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.HtmlContent
@import uk.gov.hmrc.govukfrontend.views.viewmodels.fieldset.Fieldset
@import uk.gov.hmrc.govukfrontend.views.Aliases.ErrorSummary
@import uk.gov.hmrc.govukfrontend.views.Implicits._

@this(
  main: views.html.main,
  errorSummary: uk.gov.hmrc.govukfrontend.views.html.components.GovukErrorSummary,
  radios: uk.gov.hmrc.govukfrontend.views.html.components.GovukRadios,
  viewsHelpers: views.ViewsHelpers
)

@(
        redirectCall: Call,
        regularAmountForm: Form[SelectedPlanAmount],
        schedules: Map[Int, PaymentSchedule])(
        implicit
        messages: play.api.i18n.Messages,
        request: Request[_],
        appConfig: config.AppConfig
)

@main(
    title = Messages("ssttp.calculator.results.title"),
    backButtonUrl = Some(ssttparrangement.routes.ArrangementController.getChangeSchedulePaymentDay())
) {

<section class="govuk-body">

@if(regularAmountForm.hasErrors) {
    @errorSummary(
        ErrorSummary(
            title = Text(Messages("ssttp.calculator.results.error.title")),
            errorList = regularAmountForm.errors.asTextErrorLinks.map {error =>
                if(error.href.forall(_.contains("chosen-regular-amount"))) error.copy (
                    href = schedules.headOption.fold(error.href)(s => error.href.map(_.replaceAll("chosen-regular-amount", s._1.toString)))
                ) else error
            }
        )
    )
}

@viewsHelpers.form(redirectCall, 'id -> "paymentTodayForm") {
    <fieldset class="govuk-fieldset">
        <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
            <h1 class="govuk-fieldset__heading">@Messages("ssttp.calculator.results.title")</h1>
        </legend>

        @radios(Radios(
            name = "chosen-regular-amount",
            attributes = Map("id" -> "chosen-regular-amount"),
            items = schedules.toSeq.map ( schedule => {
                RadioItem(
                    id = Some(schedule._1.toString),
                    value = Some(schedule._2.getMonthlyInstalment.toString),
                    content = HtmlContent(
                        instalment_by_month_label(schedule._2)
                    ),

                    conditionalHtml = Some(instalment_by_month_conditional(schedule._2))
                )
            })
        ))
    </fieldset>
<details class="govuk-details">
 <summary class="govuk-details__summary"><span class="govuk-details__summary-text">@Messages("ssttp.calculator.results.section.title")</span></summary>
 <div class="govuk-details__text">
  <p>@Messages("ssttp.calculator.results.section.p1")</p>
  <p>@Messages("ssttp.calculator.results.section.p2")</p>
  <p>@Messages("ssttp.calculator.results.section.p3")</p>
 </div>
</details>

<details class="govuk-details">
  <summary class="govuk-details__summary"><span class="govuk-details__summary-text">@Messages("ssttp.calculator.check-calculation.cant-afford")</span></summary>
  <div class="govuk-details__text">
    <p>@Messages("ssttp.calculator.check-calculation.cant-afford.p1")</p>
    <p>@Messages("ssttp.calculator.check-calculation.cant-afford.p2.1") <strong class="bold">@Messages("ssttp.calculator.check-calculation.cant-afford.p2.2")</strong> @Messages("ssttp.calculator.check-calculation.cant-afford.p2.3")</p>
      <p>@{Html(Messages("ssttp.calculator.check-calculation.cant-afford.p3"))}</p>
      <p>@{Html(Messages("ssttp.calculator.check-calculation.cant-afford.p4"))}</p>
      <p>@{Html(Messages("ssttp.calculator.check-calculation.cant-afford.p5"))}</p>
  </div>
</details>

<div class="clear">
 <div class="form-group">
  <button id="next" type="submit" class="govuk-button" onclick="continue()">@Messages("ssttp.calculator.form.continue")</button>
 </div>
</div>
}

</section>
}